name: CD â€“ Build & Deploy (GHCR)

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-push:
    name: ðŸ—ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/truppe-api:latest
            ghcr.io/${{ github.repository_owner }}/truppe-api:${{ github.event.release.tag_name }}

  deploy:
    name: ðŸš€ Deploy to Server
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ðŸ” Setup SSH Key
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > id_ed25519
          chmod 600 id_ed25519
          eval $(ssh-agent -s)
          ssh-add id_ed25519

      - name: ðŸš€ SSH and deploy
        run: |
          ssh -i id_ed25519 -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
          cd ~/docker
          git pull origin main
          docker compose -f docker-compose.truppe-api.yml pull
          docker compose -f docker-compose.truppe-api.yml up -d
          docker image prune -f
          EOF
