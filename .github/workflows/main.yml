name: CI/CD Pipeline â€“ Test & Deploy

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  test:
    name: âœ… Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install Dependencies
        run: npm install
        env:
          SKIP_HUSKY: true

      - name: ðŸ§ª Run Tests
        run: npm run test

  deploy:
    name: ðŸš€ Deploy to Server
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: ðŸ“¦ Install Production Dependencies
        run: npm install --omit=dev
        env:
          SKIP_HUSKY: true

      - name: ðŸ“¦ Archive release contents
        run: zip -r release.zip . -x ".git/*"

      - name: ðŸ” Setup SSH Key
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > id_ed25519
          chmod 600 id_ed25519
          eval $(ssh-agent -s)
          ssh-add id_ed25519

      - name: ðŸš€ Deploy to Server via SSH
        run: |
          scp -i id_ed25519 -o StrictHostKeyChecking=no release.zip root@${{ secrets.SERVER_HOST }}:/root/madm-api-release.zip

          ssh -i id_ed25519 -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} <<EOF
          rm -rf ~/madm-api
          mkdir ~/madm-api
          unzip -o /root/madm-api-release.zip -d ~/madm-api

          cd ~/docker
          docker-compose pull
          docker-compose build --no-cache
          docker-compose up -d madm-api
          docker image prune -f
          EOF
